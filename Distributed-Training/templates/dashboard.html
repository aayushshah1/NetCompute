<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Training Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding: 20px; }
        .card { margin-bottom: 20px; }
        .progress { height: 25px; }
        .worker-card { transition: background-color 0.3s; }
        .worker-card.inactive { background-color: #f8d7da; }
        .gauge-container {
            width: 150px;
            height: 150px;
            position: relative;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Distributed Training Dashboard</h1>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>Job Progress</h4>
                    </div>
                    <div class="card-body">
                        <div class="progress">
                            <div id="progress-bar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between">
                            <span id="tasks-completed">0</span>
                            <span>of</span>
                            <span id="tasks-total">0 tasks</span>
                        </div>
                        <div class="mt-3">
                            <strong>Elapsed Time:</strong> <span id="elapsed-time">0:00</span>
                            <div id="remaining-container" class="d-none">
                                <strong>Estimated Remaining:</strong> <span id="remaining-time">0:00</span>
                            </div>
                            <div id="completion-container" class="d-none">
                                <strong class="text-success">Completed in:</strong> <span id="completion-time">0:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4>System Resources</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="gauge-container">
                                    <canvas id="cpu-gauge"></canvas>
                                </div>
                                <p class="text-center">Average CPU Usage</p>
                            </div>
                            <div class="col-md-6">
                                <div class="gauge-container">
                                    <canvas id="memory-gauge"></canvas>
                                </div>
                                <p class="text-center">Average Memory Usage</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white">
                <h4>Worker Status <span id="worker-count" class="badge bg-light text-dark">0</span></h4>
            </div>
            <div class="card-body">
                <div id="workers-container" class="row"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Initialize Charts
        const cpuGauge = new Chart(document.getElementById('cpu-gauge'), {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['#198754', '#f0f0f0']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                circumference: 180,
                rotation: -90,
                cutout: '80%',
                plugins: { tooltip: { enabled: false } }
            }
        });

        const memoryGauge = new Chart(document.getElementById('memory-gauge'), {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['#0d6efd', '#f0f0f0']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                circumference: 180,
                rotation: -90,
                cutout: '80%',
                plugins: { tooltip: { enabled: false } }
            }
        });

        // Format time as MM:SS
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === null) return "00:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Handle Socket.IO events
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('update_stats', (data) => {
            // Update progress bar
            const progress = data.total_tasks > 0 ? (data.completed_tasks / data.total_tasks) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-bar').textContent = `${progress.toFixed(1)}%`;
            
            // Update tasks count
            document.getElementById('tasks-completed').textContent = data.completed_tasks;
            document.getElementById('tasks-total').textContent = data.total_tasks + ' tasks';
            
            // Update elapsed time
            document.getElementById('elapsed-time').textContent = formatTime(data.elapsed_time);
            
            // Handle completion time or estimates
            if (data.completion_time) {
                document.getElementById('remaining-container').classList.add('d-none');
                document.getElementById('completion-container').classList.remove('d-none');
                document.getElementById('completion-time').textContent = formatTime(data.completion_time);
                
                // Set progress to 100% when complete
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-bar').textContent = '100%';
            } else if (data.estimated_completion_time) {
                document.getElementById('remaining-container').classList.remove('d-none');
                document.getElementById('remaining-time').textContent = formatTime(data.estimated_completion_time.remaining);
            }
            
            // Update resource gauges
            if (data.avg_cpu !== undefined) {
                cpuGauge.data.datasets[0].data = [data.avg_cpu, 100 - data.avg_cpu];
                cpuGauge.update();
            }
            
            if (data.avg_memory !== undefined) {
                memoryGauge.data.datasets[0].data = [data.avg_memory, 100 - data.avg_memory];
                memoryGauge.update();
            }
            
            // Update worker count
            const workerCount = data.workers_count || Object.keys(data.workers || {}).length;
            document.getElementById('worker-count').textContent = workerCount;
            
            // Update worker cards
            updateWorkerCards(data.workers || {});
        });

        function updateWorkerCards(workers) {
            const container = document.getElementById('workers-container');
            const currentTime = Date.now() / 1000;
            const workerIds = Object.keys(workers);
            
            // First, update existing cards and track which ones are still present
            const existingCards = {};
            document.querySelectorAll('.worker-card').forEach(card => {
                const workerId = card.dataset.workerId;
                existingCards[workerId] = card;
                
                // Check if worker still exists
                if (!workers[workerId]) {
                    card.remove();
                    return;
                }
                
                const worker = workers[workerId];
                
                // Check if worker is active (seen in the last 10 seconds)
                const isActive = currentTime - worker.last_seen < 10;
                card.classList.toggle('inactive', !isActive);
                
                // Update worker stats
                card.querySelector('.cpu-value').textContent = `${worker.cpu?.toFixed(1) || 0}%`;
                card.querySelector('.memory-value').textContent = `${worker.memory?.toFixed(1) || 0}%`;
                card.querySelector('.tasks-value').textContent = worker.tasks_processed || 0;
                
                if (worker.current_task) {
                    card.querySelector('.current-task').textContent = `Task #${worker.current_task}`;
                } else {
                    card.querySelector('.current-task').textContent = 'Idle';
                }
            });
            
            // Add new worker cards
            workerIds.forEach(workerId => {
                if (existingCards[workerId]) return; // Skip existing workers
                
                const worker = workers[workerId];
                const isActive = currentTime - worker.last_seen < 10;
                
                const card = document.createElement('div');
                card.className = `col-md-4 mb-3 worker-card ${isActive ? '' : 'inactive'}`;
                card.dataset.workerId = workerId;
                
                card.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5>Worker: ${workerId}</h5>
                            <small>${worker.hostname || 'Unknown'}</small>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>CPU: <span class="cpu-value">${worker.cpu?.toFixed(1) || 0}%</span></div>
                                <div>Memory: <span class="memory-value">${worker.memory?.toFixed(1) || 0}%</span></div>
                            </div>
                            <div class="mt-2">
                                <div>Tasks completed: <span class="tasks-value">${worker.tasks_processed || 0}</span></div>
                                <div>Current task: <span class="current-task">${worker.current_task ? `Task #${worker.current_task}` : 'Idle'}</span></div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>